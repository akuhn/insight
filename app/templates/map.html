<html>
<head>
	<link href="static/bootstrap/css/bootstrap.css" rel="stylesheet" />
	<link href="static/bootstrap/css/bootstrap-responsive.css" rel="stylesheet" />
	<style>
		body {
			padding-top: 60px;
		}	
		.square {
		    display: inline-block;
		    position: relative;
		    width: 100%;
		}
		.square_ratio {
		    margin-top: 100%;
		}
		.square_div {
		    position: absolute;
		    top: 0;
		    bottom: 0;
		    left: 0;
		    right: 0;
				background: silver;
		}
	</style>
</head>
<body onload="initialize()">

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="#">Serendipty Engine</a>
          <div class="nav-collapse collapse pull-right">
            <ul class="nav">
              <li class="active"><a href="#">Home</a></li>
              <li><a href="#about">About</a></li>
              <li><a href="#contact">Contact</a></li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Dropdown <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li><a href="#">Action</a></li>
                  <li><a href="#">Another action</a></li>
                  <li><a href="#">Something else here</a></li>
                  <li class="divider"></li>
                  <li class="nav-header">Nav header</li>
                  <li><a href="#">Separated link</a></li>
                  <li><a href="#">One more separated link</a></li>
                </ul>
              </li>
            </ul>
          </div>
		</div>  
      </div>
    </div>
	
	<div class="container">
		<div class="row">
			<div class="span5">
				<div style="position:fixed;width:470px">
					<div class="square" style="margin: 16 0">
				    <div class="square_ratio"></div>
				    <div id="map_canvas" class="square_div">
				    </div>
					</div>
					<p>
						<bigger><b>Total time:</b> 6 hours (including lunch break)</bigger>
						<!-- ><h3>But, <a href="">how has this been generated?</a></h3> -->
					</p>	
				</div>
			</div>
			<div class="span7">
				<h2>Your Personal Day in Vancouver</h2>
				Based on your Facebook likes and 1,034,651 geotags found on Flickr.
				<hr>
				{% for each in itinerary %}
				{% if each.name %}
				<div>
							<img src="{{each.photo_url}}" style="float:left;margin:2px 12px 24px 0px;background:silver;width:80px;height:80px;" />
							<h4 id="{{ each.cssid }}">{{each.name}} <small>&mdash; most people spent {{each.time}} min here</small></h4>
							<p>{{each.description}}&hellip; (<a href="{{each.url}}">read more on Lonely Planet)</a></p>
							<br style="clear:both"/>
				</div>			
				{% else %}
					<p style="clear:both">Walk about {{each.time}} min to &hellip;</p>
				{% endif %}
				{% endfor %}
				</div>
			</div>
		</div>				
	</div>

	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.0/jquery-ui.min.js"></script>
  <script src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
	<script src="static/bootstrap/js/bootstrap.js"></script>
	<script>
		$('#navbar').affix()
		function initialize() {
			
			var mapOptions = {
				mapTypeId: google.maps.MapTypeId.ROADMAP,
				center: new google.maps.LatLng(49.285, -123.13),
				zoom: 13,
				disableDefaultUI: true,
				zoomControl: true,
				panControl: true
			};
			var map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
		
			var path = [{% for each in itinerary %}{% if each.name %}
				[{{ each.latitude }},{{ each.longitude }},"{{ each.cssid }}"],
			{% endif %}{% endfor %}]

			jQuery.fn.flash = function( )
			{
			    var current = this.css( 'color' );
			    this.animate( { 'background-color': 'rgb(255,255,127)' }, 500 );
			    this.animate( { 'background-color': 'white' }, 500 );
			}


			path.forEach(function(each) {
				var loc = new google.maps.LatLng(each[0],each[1])
        var marker = new google.maps.Marker({
            position: loc,
            map: map,
            title: each[2]
        })
		    google.maps.event.addListener(marker, 'click', function(){
					var offset = $('#'+each[2]).offset();
					$('html, body').animate({
					    scrollTop: offset.top - 200,
					    scrollLeft: offset.left
					});
					$('#'+each[2]).parent().flash();
				});
			})
		
			var directionsService = new google.maps.DirectionsService();
		  var directionsDisplay = new google.maps.DirectionsRenderer();
		  directionsDisplay.setMap(map);

			var bounds = new google.maps.LatLngBounds();
			
			var prev = null
			path.forEach(function(each) {
				var curr = new google.maps.LatLng(each[0],each[1])
			  if (prev) {
					var polyline = new google.maps.Polyline({
						path: [],
						strokeColor: '#0000FF',
						strokeWeight: 4
					});
					/*  */
					var request = { 
						origin: prev, 
						destination: curr, 
						travelMode: google.maps.DirectionsTravelMode.WALKING, 
					};
					directionsService.route(request, function(result, status) { 
						if (status == google.maps.DirectionsStatus.OK) {
							path = result.routes[0].overview_path;
						
							$(path).each(function(index, item) {
								polyline.getPath().push(item);
								bounds.extend(item);
							})

							polyline.setMap(map);
						}
					});
			  }
				prev = curr;
			})
			
			console.log(bounds)
			
			/* map.fitBounds(bounds); */
		
		}
	</script>
</body>		